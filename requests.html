<!doctype html>

<html lang="en">

<head>

  <meta charset="utf-8"/>

  <meta name="viewport" content="width=device-width, initial-scale=1"/>

  <title>Recent requests — HelpAroundYou</title>

  <link rel="stylesheet" href="styles.css"/>

  <script>

    // عدّل حسبك:

    const WEB_APP_URL = "PASTE_YOUR_WEB_APP_URL_HERE";  // يجب أن يدعم ?action=list

    const SHEET_ID = "PASTE_YOUR_SHEET_ID_HERE";        // fallback

    const SHEET_GID = "0"; // غيّرها لو كانت التبويبة ليست الأولى

  </script>

</head>

<body>

<header class="site-header">

  <a class="brand" href="/">

    <svg class="brand-mark" width="24" height="24" viewBox="0 0 64 64" aria-hidden="true">

      <defs><linearGradient id="g3" x1="0" y1="0" x2="1" y2="1"><stop offset="0" stop-color="#8b5cf6"/><stop offset="1" stop-color="#6366f1"/></linearGradient></defs>

      <circle cx="32" cy="32" r="28" fill="url(#g3)"/><circle cx="22" cy="42" r="7" fill="#fff" opacity=".95"/><path d="M46 26c0 6-12 2-12 2s6-8 12-8v6z" fill="#fff" opacity=".95"/>

    </svg>

    <span class="brand-name"><strong>Help</strong><strong>Around</strong><strong>You</strong></span>

  </a>

  <nav class="top-actions">

    <a class="btn primary" href="post.html">Post a request</a>

  </nav>

</header>



<main class="page-wide">

  <h1>Recent Requests</h1>

  <div id="list" class="cards"></div>

  <p id="fallback" class="muted" style="display:none">

    Could not load requests.

  </p>

</main>



<footer class="site-footer">© 2025 HelpAroundYou</footer>



<script>

async function loadFromWebApp() {

  const url = `${WEB_APP_URL}?action=list&limit=25`;

  const res = await fetch(url);

  if (!res.ok) throw new Error('webapp list failed');

  return res.json();

}



async function loadFromSheetCSV() {

  const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&gid=${SHEET_GID}`;

  const res = await fetch(url);

  if (!res.ok) throw new Error('sheet csv failed');

  const csv = await res.text();

  // بسيط: نفصل أول 25 صف بعد العناوين

  const rows = csv.split(/\r?\n/).map(r => r.split(/,(?=(?:[^"]*"[^"]*")*[^"]*$)/));

  const header = rows.shift();

  const items = rows.slice(0,25).filter(r=>r.length>3).map(r => ({

    timestamp: r[0], email: r[1], title: r[2], description: r[3],

    category: r[4], location: r[5], date: r[6], contact: r[7] || ''

  }));

  return items;

}



function render(items) {

  const wrap = document.getElementById('list');

  if (!items || !items.length) {

    document.getElementById('fallback').style.display = 'block';

    return;

  }

  wrap.innerHTML = items.map(item => `

    <article class="card request">

      <div class="req-head">

        <h3>${escapeHtml(item.title || '')}</h3>

        <span class="pill">${escapeHtml(item.category || '')}</span>

      </div>

      <p class="muted">${escapeHtml(item.location || '')} · ${escapeHtml(item.date || '')}</p>

      <p>${escapeHtml(item.description || '')}</p>

    </article>

  `).join('');

}



function escapeHtml(s){return String(s).replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]));}



(async () => {

  try {

    let items;

    try {

      items = await loadFromWebApp(); // يتوقع {title, description, category, location, date}

    } catch(_) {

      items = await loadFromSheetCSV();

    }

    render(items);

  } catch (err) {

    console.error(err);

    document.getElementById('fallback').style.display = 'block';

  }

})();

</script>

</body>

</html>
