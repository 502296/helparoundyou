<!DOCTYPE html>

<html lang="en">

<head>

  <meta charset="UTF-8"/>

  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>

  <title>Requests â€” HelpAroundYou</title>

  <link rel="stylesheet" href="style.css?v=7"/>

</head>

<body>

  <header class="hay-header">

    <a href="index.html" class="logo">

      <span class="logo-main">Help</span><span class="logo-around">Around</span><span class="logo-you">You</span>

    </a>

    <nav class="hay-actions">

      <a href="list.html" class="btn secondary active">See Requests</a>

      <a href="post.html" class="btn primary">Post a Request</a>

    </nav>

  </header>



  <div class="page-wrap">

    <h1 style="margin:12px 0 14px;">Neighbor Requests</h1>



    <!-- Filters -->

    <div class="filters">

      <div class="group">

        <input id="q" type="search" placeholder="Search title or description"/>

        <select id="cat">

          <option value="">All categories</option>

          <option>Moving help</option>

          <option>Pickup with truck</option>

          <option>Yard cleanup (leaves/branches)</option>

          <option>Cleaning</option>

          <option>Small fix / handyman</option>

          <option>Other</option>

        </select>

        <input id="area" type="text" placeholder="ZIP / Area (e.g., 40218 or Highlands)"/>

        <input id="date" type="date" />

      </div>

      <div class="group">

        <select id="sort">

          <option value="new">Newest first</option>

          <option value="old">Oldest first</option>

        </select>

        <button class="btn primary" id="applyBtn">Apply</button>

        <button class="btn secondary" id="clearBtn" type="button">Clear</button>

      </div>

    </div>



    <!-- Results -->

    <div id="results" class="grid" aria-live="polite" aria-busy="true"></div>

    <div id="empty" class="empty" style="display:none">No results. Try different filters.</div>

    <div id="loading" class="empty"><span class="spinner"></span> Loading requestsâ€¦</div>



    <p class="muted" style="margin-top:14px">

      Privacy-first: requests only show whatâ€™s needed. Contact happens directly between neighbors.

    </p>

  </div>



  <footer class="hay-footer">

    Â© 2025 HelpAroundYou â€” Free to use. Built with care for our community â™¥

  </footer>



  <script>

    // Google Sheets config

    const SHEET_ID = '1OAw6rFiPPyKXSk7Je4hU_dZdzWwLT3x23i8TRBnoj04';

    const SHEET_GID = '407846975'; // Form Responses 1



    const COLS = {

      title: 'Request Title',

      description: 'Description',

      category: 'Category',

      area: 'Location',

      date: 'Date Needed',

      email: 'Email Address',

      contact: 'Contact Info',

      file: 'Photo / File'

    };



    const $ = (s, p=document)=>p.querySelector(s);

    const resultsEl = $('#results'), emptyEl = $('#empty'), loadingEl = $('#loading');

    const qEl=$('#q'), catEl=$('#cat'), areaEl=$('#area'), dateEl=$('#date'), sortEl=$('#sort');



    const esc = s => (s??'').toString().replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));

    const fmtIso = s => { const d=new Date(s); return isNaN(d)? (s||'') : d.toISOString().slice(0,10); };

    const fmtNice = s => { const d=new Date(s); return isNaN(d)? (s||'') : d.toLocaleDateString(undefined,{month:'short',day:'numeric',year:'numeric'}); };



    async function getRequestsFromSheet(){

      let url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json`;

      if (SHEET_GID) url += `&gid=${encodeURIComponent(SHEET_GID)}`;

      const res = await fetch(url, {cache:'no-store'});

      const text = await res.text();

      const json = JSON.parse(text.substr(47).slice(0,-2));



      const headers = json.table.cols.map(c => (c && c.label) ? c.label.trim() : '');

      const idx = name => headers.findIndex(h => h.toLowerCase() === (name||'').toLowerCase());

      const I = {

        title: idx(COLS.title), description: idx(COLS.description),

        category: idx(COLS.category), area: idx(COLS.area), date: idx(COLS.date),

        email: idx(COLS.email), contact: idx(COLS.contact), file: idx(COLS.file)

      };



      const rows = json.table.rows || [];

      return rows.map(r => {

        const c = r.c || [];

        const get = i => (i>=0 && c[i] && (c[i].v ?? c[i].f)) || '';

        return {

          title: get(I.title),

          blurb: get(I.description),

          category: get(I.category),

          area: get(I.area),

          date: fmtIso(get(I.date)),

          email: get(I.email),

          contact: get(I.contact),

          file: get(I.file)

        };

      }).filter(x => x.title || x.blurb);

    }



    function render(list){

      resultsEl.setAttribute('aria-busy','true');

      resultsEl.innerHTML = '';

      if(!list.length){

        loadingEl.style.display='none'; emptyEl.style.display='block';

        resultsEl.setAttribute('aria-busy','false'); return;

      }

      emptyEl.style.display='none'; loadingEl.style.display='none';



      for (const r of list){

        const fileBtn = r.file ? `<a class="btn secondary" href="${esc(r.file)}" target="_blank" rel="noopener">View file</a>` : '';

        const helpHref = `help.html?title=${encodeURIComponent(r.title||'')}&cat=${encodeURIComponent(r.category||'')}&area=${encodeURIComponent(r.area||'')}&date=${encodeURIComponent(r.date||'')}`;

        const card = document.createElement('div');

        card.className = 'req-card';

        card.innerHTML = `

          <div class="req-title">${esc(r.title)}</div>

          <div class="req-meta">

            <span class="badge violet">${esc(r.category)}</span>

            <span class="badge blue">${esc(r.area)}</span>

            <span class="muted" title="Date needed">ðŸ“… ${esc(fmtNice(r.date))}</span>

          </div>

          <div class="desc">${esc(r.blurb)}</div>

          <div class="actions">

            <a class="btn primary" href="${helpHref}">Offer to help</a>

            ${fileBtn}

          </div>

        `;

        resultsEl.appendChild(card);

      }

      resultsEl.setAttribute('aria-busy','false');

    }



    let RAW = [];

    function applyFilters(){

      const q    = (qEl.value||'').trim().toLowerCase();

      const cat  = catEl.value;

      const area = (areaEl.value||'').trim().toLowerCase();

      const date = dateEl.value;



      let list = [...RAW];

      if(q){ list = list.filter(r => (r.title||'').toLowerCase().includes(q) || (r.blurb||'').toLowerCase().includes(q)); }

      if(cat){ list = list.filter(r => (r.category||'') === cat); }

      if(area){ list = list.filter(r => (r.area||'').toLowerCase().includes(area)); }

      if(date){ list = list.filter(r => (r.date||'') >= date); }

      list.sort((a,b)=> sortEl.value==='new' ? ((b.date||'')>(a.date||'')?1:-1) : ((a.date||'')>(b.date||'')?1:-1));



      render(list); saveQueryToURL();

    }

    function clearFilters(){ qEl.value=''; catEl.value=''; areaEl.value=''; dateEl.value=''; sortEl.value='new'; applyFilters(); }

    document.getElementById('applyBtn').addEventListener('click', applyFilters);

    document.getElementById('clearBtn').addEventListener('click', clearFilters);

    qEl.addEventListener('keydown', e=>{ if(e.key==='Enter'){ e.preventDefault(); applyFilters(); } });



    function saveQueryToURL(){

      const p = new URLSearchParams();

      if(qEl.value) p.set('q', qEl.value);

      if(catEl.value) p.set('cat', catEl.value);

      if(areaEl.value) p.set('area', areaEl.value);

      if(dateEl.value) p.set('date', dateEl.value);

      if(sortEl.value!=='new') p.set('sort', sortEl.value);

      history.replaceState(null,'',location.pathname+(p.toString()?('?'+p.toString()):'')); }



    function restoreFromURL(){

      const p = new URLSearchParams(location.search);

      if(p.get('q')) qEl.value=p.get('q');

      if(p.get('cat')) catEl.value=p.get('cat');

      if(p.get('area')) areaEl.value=p.get('area');

      if(p.get('date')) dateEl.value=p.get('date');

      if(p.get('sort')) sortEl.value=p.get('sort'); }



    (async function init(){

      restoreFromURL();

      try{ RAW = await getRequestsFromSheet(); }

      catch(err){ console.error(err); loadingEl.innerHTML = 'Could not load from Google Sheets. Check sharing settings and IDs.'; }

      applyFilters();

    })();

  </script>

</body>

</html>
