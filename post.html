<!doctype html>

<html lang="en">

<head>

  <meta charset="utf-8" />

  <meta name="viewport" content="width=device-width,initial-scale=1" />

  <title>Post a request — HelpAroundYou</title>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">

  <link rel="stylesheet" href="style.css" />

</head>

<body>

  <header class="site-header compact">

    <a class="brand" href="index.html">Help<span class="brand-accent">Around</span>You</a>

    <nav class="site-nav">

      <a class="nav-link" href="requests.html">Requests</a>

    </nav>

  </header>



  <main class="section">

    <div class="container narrow">

      <h1 class="section-title">Post a request</h1>



      <form id="requestForm" class="card form-card" novalidate>

        <div class="form-row">

          <label for="title">Title <span class="req">*</span></label>

          <input id="title" name="title" type="text" placeholder="Pickup small sofa, 5 miles" required />

        </div>



        <div class="form-row two">

          <div>

            <label for="category">Category <span class="req">*</span></label>

            <select id="category" name="category" required>

              <option value="">Select…</option>

              <option>Lawn care</option>

              <option>Moving / Truck pickup</option>

              <option>Cleaning</option>

              <option>Repairs / Assembly</option>

              <option>Custom task</option>

            </select>

          </div>

          <div>

            <label for="zip">ZIP / Area <span class="req">*</span></label>

            <input id="zip" name="zip" type="text" inputmode="numeric" placeholder="e.g., 40218" required />

          </div>

        </div>



        <div class="form-row two">

          <div>

            <label for="date">Date</label>

            <input id="date" name="date" type="date" />

          </div>

          <div>

            <label for="time">Time</label>

            <input id="time" name="time" type="time" />

          </div>

        </div>



        <div class="form-row">

          <label for="desc">Description</label>

          <textarea id="desc" name="desc" rows="3" placeholder="Short details, size/weight, timing…"></textarea>

        </div>



        <div class="form-row">

          <label for="files">Photos / Files (up to 5)</label>

          <input id="files" name="files" type="file" multiple accept="image/*,.pdf,.doc,.docx,.png,.jpg,.jpeg" />

          <small class="hint">Uploads are optional. No sign-in required.</small>

        </div>



        <details class="form-row">

          <summary>Optional contact (kept private)</summary>

          <div class="stack">

            <label for="contactName">Name</label>

            <input id="contactName" name="contactName" type="text" placeholder="First name" />

            <label for="contactPhone">Phone</label>

            <input id="contactPhone" name="contactPhone" type="tel" placeholder="(555) 555-5555" />

            <label for="contactEmail">Email</label>

            <input id="contactEmail" name="contactEmail" type="email" placeholder="you@example.com" />

          </div>

        </details>



        <div class="form-actions">

          <button class="btn btn-primary" type="submit">Submit</button>

          <a href="index.html" class="btn btn-ghost">Back</a>

        </div>



        <p id="formMsg" class="form-msg" role="status" aria-live="polite"></p>

      </form>



      <p class="muted center small">

        HelpAroundYou is a free platform that connects neighbors and local doers. You agree directly with each other.

      </p>

    </div>

  </main>



  <script>

    // ===== Frontend -> Serverless Proxy (no keys in client) =====

    const API = ''; // نفس الدومين



    const form = document.getElementById('requestForm');

    const msg = document.getElementById('formMsg');

    const filesInput = document.getElementById('files');



    async function getSignedUrl(filename, type){

      const r = await fetch(`${API}/api/upload-url`, {

        method:'POST',

        headers:{ 'Content-Type':'application/json' },

        body: JSON.stringify({ filename, contentType:type })

      });

      if (!r.ok) throw new Error('upload-url failed');

      return r.json(); // {uploadUrl, path, publicUrl}

    }



    async function uploadViaSignedUrl(file){

      const { uploadUrl, publicUrl, path } = await getSignedUrl(file.name, file.type);

      const put = await fetch(uploadUrl, { method:'PUT', headers:{ 'Content-Type': file.type || 'application/octet-stream' }, body:file });

      if (!put.ok) throw new Error('upload PUT failed');

      return { name:file.name, size:file.size, path, url: publicUrl };

    }



    form.addEventListener('submit', async (e) => {

      e.preventDefault();

      msg.textContent = ''; msg.className = 'form-msg';



      if (!form.checkValidity()){

        msg.textContent = 'Please complete required fields.';

        msg.className = 'form-msg error';

        return;

      }



      const payload = {

        title: document.getElementById('title').value.trim(),

        category: document.getElementById('category').value,

        zip: document.getElementById('zip').value.trim(),

        need_date: document.getElementById('date').value || null,

        need_time: document.getElementById('time').value || null,

        description: document.getElementById('desc').value.trim() || null,

        contact_name: document.getElementById('contactName')?.value || null,

        contact_phone: document.getElementById('contactPhone')?.value || null,

        contact_email: document.getElementById('contactEmail')?.value || null,

        files: null

      };



      try {

        // 1) رفع الملفات عبر signed URL (اختياري)

        if (filesInput.files.length){

          const list = Array.from(filesInput.files).slice(0,5);

          const uploaded = [];

          for (const f of list){ uploaded.push(await uploadViaSignedUrl(f)); }

          payload.files = uploaded;

        }



        // 2) إدخال الطلب في قاعدة البيانات عبر الـProxy

        const r = await fetch(`${API}/api/requests`, {

          method:'POST',

          headers:{ 'Content-Type':'application/json' },

          body: JSON.stringify(payload)

        });

        if (!r.ok) throw new Error('insert failed');



        msg.textContent = 'Thanks! Your request has been posted.';

        msg.className = 'form-msg success';

        form.reset();

        window.scrollTo({ top: 0, behavior: 'smooth' });

      } catch (err){

        console.error(err);

        msg.textContent = 'Sorry—something went wrong. Please try again.';

        msg.className = 'form-msg error';

      }

    });

  </script>

</body>

</html>
